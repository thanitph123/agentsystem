<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Coach AI (Debug Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .loading-spinner { border-top-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-6">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">üõ°Ô∏è Insurance Coach AI (Debug Mode)</h1>
            <p class="text-gray-600">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
        </div>

        <div class="bg-red-50 p-4 rounded-lg mb-6 border border-red-200 text-sm text-red-800">
            <strong>‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô Local Server (http://localhost:8000) ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ Double Click ‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Browser ‡∏à‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        </div>

        <div class="bg-blue-50 p-6 rounded-lg mb-6 border border-blue-100">
            <label class="block text-sm font-medium text-gray-700 mb-2">1. Gemini API Key</label>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div class="mb-8">
            <label class="block text-sm font-medium text-gray-700 mb-2">2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏•‡∏¥‡∏õ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ)</label>
            <div class="flex items-center justify-center w-full">
                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <p class="text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå MP4</span></p>
                    </div>
                    <input id="fileInput" type="file" accept="video/mp4" class="hidden" />
                </label>
            </div>
            <div id="fileNameDisplay" class="text-sm text-gray-600 mt-2 text-center"></div>
        </div>

        <button id="analyzeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏•‡∏¥‡∏õ
        </button>

        <div id="statusLog" class="mt-4 text-center text-sm text-gray-500"></div>

        <div id="loading" class="hidden mt-6 text-center">
            <div class="w-8 h-8 border-4 border-blue-600 border-solid rounded-full animate-spin loading-spinner mx-auto"></div>
            <p class="mt-2 text-gray-600">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</p>
        </div>

        <div id="resultSection" class="hidden mt-8 border-t pt-6">
            <h3 class="font-bold text-xl mb-4">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</h3>
            <div class="bg-gray-100 p-4 rounded whitespace-pre-wrap text-sm font-mono" id="rawOutput"></div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const fileInput = document.getElementById('fileInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('resultSection');
        const statusLog = document.getElementById('statusLog');

        // Display Filename
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) document.getElementById('fileNameDisplay').innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
        });

        function log(msg) {
            console.log(msg);
            statusLog.innerText = msg;
        }

        async function fileToGenerativePart(file) {
            log("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏õ‡πá‡∏ô Base64... (‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà)");
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve({
                    inlineData: { data: reader.result.split(',')[1], mimeType: file.type },
                });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        analyzeBtn.addEventListener('click', async () => {
            const apiKey = document.getElementById('apiKeyInput').value;
            const file = fileInput.files[0];

            if (!apiKey) return alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å API Key');
            if (!file) return alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠');
            if (file.size > 25 * 1024 * 1024) return alert('‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 25MB Browser ‡∏≠‡∏≤‡∏à‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Ñ‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡∏Ñ‡∏£‡∏±‡∏ö');

            loading.classList.remove('hidden');
            resultSection.classList.add('hidden');
            analyzeBtn.disabled = true;
            
            try {
                log("üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini API...");
                const genAI = new GoogleGenerativeAI(apiKey);
                
                // ‡πÉ‡∏ä‡πâ Model ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå
                const videoPart = await fileToGenerativePart(file);
                log("‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI...");

                const prompt = `
                ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ä‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON Format ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
                {
                    "transcription": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î",
                    "analysis": "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
                    "feedback": "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
                    "encouragement": "‡∏Ñ‡∏≥‡∏ä‡∏°‡πÄ‡∏ä‡∏¢"
                }
                `;

                const result = await model.generateContent([prompt, videoPart]);
                log("‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...");
                
                const response = await result.response;
                const text = response.text();
                
                loading.classList.add('hidden');
                resultSection.classList.remove('hidden');
                document.getElementById('rawOutput').innerText = text;
                log("üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!");

            } catch (error) {
                loading.classList.add('hidden');
                console.error(error);
                alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${error.toString()}\n\n(‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Console ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)`);
                log("‚ùå Error: " + error.message);
            } finally {
                analyzeBtn.disabled = false;
            }
        });
    </script>
</body>
</html>